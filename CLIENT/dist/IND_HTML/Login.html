<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sessió - KÄRŸ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="CSS.css">
  <script type="module" crossorigin src="/assets/login-Dv0FRD_H.js"></script>
</head>
<body class="page-login">
  <canvas id="particle-canvas"></canvas>

  <div class="container">
    
    <div id="app-content" class="hidden">
      <h2>Benvingut/da!</h2>
      <p>Has iniciat sessió correctament.</p>
    </div>

    <div id="login-form">
      <h2>Iniciar Sessió</h2>
      
      <form id="email-form">
        <input type="email" id="email" placeholder="El teu correu electrònic" required>
        <button type="submit">Continuar</button>
      </form>
      
      <form id="password-form" class="hidden">
        <input type="password" id="password" placeholder="Contrasenya" required>
        <input type="hidden" id="user-row"> <button type="submit" id="password-button">Iniciar Sessió</button>
      </form>
      
      <div id="status-message"></div>
    </div>
  </div>

  <script>
    let loginAction = ''; // Guardarà si hem de 'verificar' o 'establir' la contrasenya

    // Gestionar el formulari de l'email
    document.getElementById('email-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = 'Verificant...';
      statusDiv.className = '';

      google.script.run.withSuccessHandler(onUserCheckSuccess).withFailureHandler(onFailure).checkUser(email);
    });

    // Funció que s'executa quan checkUser té èxit
    function onUserCheckSuccess(response) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = '';
      
      if (response.status === 'password_exists') {
        loginAction = 'verify';
        document.getElementById('password-button').textContent = 'Iniciar Sessió';
        showPasswordStep(response.row);
      } else if (response.status === 'new_password_required') {
        loginAction = 'set';
        document.getElementById('password-button').textContent = 'Establir Contrasenya';
        showPasswordStep(response.row);
      } else { // not_found o error
        statusDiv.className = 'error';
        statusDiv.textContent = 'Email no trobat. Contacta amb l\'administrador.';
      }
    }

    // Funció per mostrar el pas de la contrasenya
    function showPasswordStep(row) {
      document.getElementById('email-form').classList.add('hidden');
      document.getElementById('password-form').classList.remove('hidden');
      document.getElementById('user-row').value = row;
      document.getElementById('email').disabled = true; // Bloquejar el camp d'email
    }

    // Gestionar el formulari de la contrasenya
    document.getElementById('password-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const password = document.getElementById('password').value;
      const row = document.getElementById('user-row').value;
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = 'Processant...';

      const data = { row: parseInt(row), password: password };

      if (loginAction === 'set') {
        google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onFailure).setPassword(data);
      } else {
        google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onFailure).verifyLogin(data);
      }
    });

    // Funció que s'executa si el login/set password és correcte.
    // CORREGIT: Aquesta funció ara gestiona la redirecció.
    function onLoginSuccess(response) {
      if (response.status === 'ok' && response.redirectUrl) {
        // Aquesta línia és la clau: redirigeix a la nova pàgina.
        window.location.href = response.redirectUrl;
      } else {
        // Si hi ha un error o no hi ha URL de redirecció, el mostrem.
        const statusDiv = document.getElementById('status-message');
        statusDiv.className = 'error';
        statusDiv.textContent = response.message || 'Ha ocorregut un error en iniciar sessió.';
      }
    }
    
    // Funció genèrica per a errors
    function onFailure(error) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.className = 'error';
      statusDiv.textContent = 'Error: ' + error.message;
    }

  </script>
  <script src="BACKGROUND.js"></script> <!-- Inclou l'animació de partícules -->
</body>
</html>